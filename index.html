<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHOBOS SHADOWS - PROTOCOL 1</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="scanline"></div>
    <div class="container">
        <h1 class="flicker">PHOBOS SHADOWS</h1>
        <p>Security protocol activated. Click the message. Good luck.</p>
        
        <div id="encrypted-box">
            <!-- The secret word is revealed here -->
            <div id="encrypted-text" data-decrypted-word="NzYxRjM3">Loading data...</div>
        </div>

        <!-- This section is now hidden until the key is revealed -->
        <div class="input-area" id="verification-area" style="display: none;">
            <input type="text" id="key-input" placeholder="ENTER REVEALED KEY...">
            <button id="verify-button">AUTHENTICATE</button>
        </div>

        <p id="feedback-message" style="opacity: 0.5; min-height: 24px;"></p>

        <!-- This is the final link, hidden until verification is successful -->
        <div id="next-challenge" style="display: none;">
            <p>PROTOCOL KEY 1 ACQUIRED. Record it.</p>
            <a href="puzzle2.html" class="button-link">Initiate Protocol 2</a>
        </div>

        <div class="footer">
            <p>LEVEL CLEAREANCE: O5</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const encryptedTextElement = document.getElementById('encrypted-text');
            const decryptedWord = encryptedTextElement.dataset.decryptedWord;
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789*&%$#@!';
            let intervalId = null;
            let isDecrypting = false;

            // --- Elements for the new verification step ---
            const verificationArea = document.getElementById('verification-area');
            const keyInput = document.getElementById('key-input');
            const verifyButton = document.getElementById('verify-button');
            const feedbackMessage = document.getElementById('feedback-message');
            const nextChallenge = document.getElementById('next-challenge');

            const startScramble = () => {
                if (isDecrypting) return;
                let scrambleCount = 0;
                intervalId = setInterval(() => {
                    let scrambledText = '';
                    for (let i = 0; i < decryptedWord.length; i++) {
                        scrambledText += alphabet[Math.floor(Math.random() * alphabet.length)];
                    }
                    encryptedTextElement.textContent = scrambledText;
                    scrambleCount++;
                    if (scrambleCount > 50 && !isDecrypting) {
                        encryptedTextElement.textContent = 'â– '.repeat(decryptedWord.length);
                        clearInterval(intervalId);
                    }
                }, 100);
            };

            const decryptText = () => {
                if (isDecrypting) return;
                isDecrypting = true;
                clearInterval(intervalId);

                let iteration = 0;
                
                const interval = setInterval(() => {
                    encryptedTextElement.textContent = decryptedWord.split('')
                        .map((letter, index) => {
                            if (index < iteration) {
                                return decryptedWord[index];
                            }
                            return alphabet[Math.floor(Math.random() * alphabet.length)];
                        })
                        .join('');

                    if (iteration >= decryptedWord.length) {
                        clearInterval(interval);
                        encryptedTextElement.textContent = decryptedWord;
                        encryptedTextElement.classList.add('decrypted');
                        encryptedTextElement.style.cursor = 'default'; // Make it not clickable anymore
                        
                        // --- MODIFICATION ---
                        // Instead of showing the link, show the verification input box.
                        verificationArea.style.display = 'block';
                    }

                    iteration += 1 / 3;
                }, 50);
            };

            const verifyKey = () => {
                if (keyInput.value === "KEY") {
                    feedbackMessage.textContent = "AUTHENTICATION SUCCESSFUL";
                    feedbackMessage.style.color = "#0f0"; // Green
                    verificationArea.style.display = 'none'; // Hide input
                    nextChallenge.style.display = 'block'; // Show final link
                } else {
                    feedbackMessage.textContent = "AUTHENTICATION FAILED. Sequence mismatch.";
                    feedbackMessage.style.color = "var(--primary-color)"; // Red
                    keyInput.value = ""; // Clear the input
                }
            };

            // --- Event Listeners ---
            encryptedTextElement.addEventListener('click', decryptText);
            verifyButton.addEventListener('click', verifyKey);
            
            // Allow pressing Enter to verify
            keyInput.addEventListener('keyup', (event) => {
                if (event.key === "Enter") {
                    verifyKey();
                }
            });

            startScramble();
        });
    </script>
</body>
</html>